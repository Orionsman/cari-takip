<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0b0d14">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Cari Takip">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/static/icon-192.png">
<title>Cari Hesap Takip</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ DeÄŸiÅŸkenler â”€â”€ */
:root {
  --bg:      #0b0d14;
  --surface: #13161f;
  --card:    #1a1e2e;
  --card2:   #20253a;
  --border:  #252b42;
  --accent:  #5b8cf5;
  --green:   #2dd4a0;
  --amber:   #f5a623;
  --red:     #f06060;
  --text:    #dde3f5;
  --sub:     #6b738f;
  --r:       16px;
  --mono:    'IBM Plex Mono', monospace;
  --serif:   'Playfair Display', serif;
  --sat:     env(safe-area-inset-top, 0px);
  --sab:     env(safe-area-inset-bottom, 0px);
}

/* â”€â”€ 2. AÃ‡IK MOD DESTEÄžÄ° â”€â”€ */
body.light {
  --bg:      #f4f6fb;
  --surface: #ffffff;
  --card:    #ffffff;
  --card2:   #f1f3f8;
  --border:  #e2e6f0;
  --text:    #111827;
  --sub:     #6b7280;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body { height: 100%; overscroll-behavior: none; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  transition: background 0.3s, color 0.3s;
}

/* â”€â”€ UI Elements â”€â”€ */
#shell { display: flex; flex-direction: column; height: 100%; height: 100dvh; }

.topbar {
  padding: calc(var(--sat) + 12px) 16px 12px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0; z-index: 100;
}
.topbar-left { display: flex; flex-direction: column; }
.topbar-title { font-family: var(--serif); font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: -0.5px; }
.topbar-right { display: flex; gap: 10px; align-items: center; }

/* Appearance HatasÄ± DÃ¼zeltmesi */
input, select, textarea {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px;
  border-radius: 10px;
  font-family: inherit;
  font-size: 14px;
  outline: none;
  width: 100%;
}

.icon-btn { 
  background: var(--card2); border: none; color: var(--text); 
  border-radius: 12px; width: 40px; height: 40px; 
  display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; 
}

.nav {
  display: grid; grid-template-columns: repeat(4, 1fr);
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding-bottom: var(--sab);
  flex-shrink: 0;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center;
  padding: 10px 0 8px; border: none; background: transparent;
  color: var(--sub); font-size: 10px; cursor: pointer; gap: 4px;
}
.nav-item.active { color: var(--accent); }
.nav-item .ni { font-size: 22px; }

.pages { flex: 1; position: relative; overflow: hidden; }
.page {
  position: absolute; inset: 0; overflow-y: auto; padding: 16px;
  display: none; flex-direction: column; gap: 16px;
  -webkit-overflow-scrolling: touch;
}
.page.active { display: flex; }

/* â”€â”€ Hareket Listesi (Ekstre) TasarÄ±mÄ± â”€â”€ */
.h-item { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 14px; margin-bottom: 10px; }
.h-row1 { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.h-desc { font-weight: 400; font-size: 14px; flex: 1; }
.h-amount { font-weight: 600; font-size: 15px; white-space: nowrap; }
.h-row2 { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 11px; }
.h-row2-left { display: flex; align-items: center; gap: 8px; color: var(--sub); }
.h-tag { font-size: 9px; padding: 2px 6px; border-radius: 6px; text-transform: uppercase; font-weight: 600; }
.tag-satis { background: rgba(91,140,245,0.15); color: var(--accent); }
.tag-odeme { background: rgba(45,212,160,0.12); color: var(--green); }
.h-bkye { color: var(--sub); font-weight: 500; }

/* Helpers */
.c-red { color: var(--red); }
.c-green { color: var(--green); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
.status-dot.offline { background: var(--sub); }
.hidden { display: none !important; }

.btn { border: none; border-radius: 12px; padding: 14px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 15px; }
.btn-accent { background: var(--accent); color: white; }

</style>
</head>
<body>

<div id="shell">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-title">â—ˆ Cari Takip</div>
      <div id="tb-crumb" style="font-size:10px; color:var(--sub); font-weight:500; margin-top:2px;"></div>
    </div>
    <div class="topbar-right">
      <span class="status-dot" id="net-dot"></span>
      <button class="icon-btn" id="theme-btn" title="Tema">ðŸŒ™</button>
      <button class="icon-btn" id="tb-add-btn" onclick="topbarAdd()">ï¼‹</button>
    </div>
  </div>

  <div class="pages">
    <div class="page active" id="pg-cariler">
      <input type="search" placeholder="Firma veya yetkili ara..." oninput="filterCariler(this.value)">
      <div id="cari-list"></div>
    </div>

    <div class="page" id="pg-detay">
      <div onclick="navTo('cariler')" style="color:var(--accent); font-weight:500; cursor:pointer; display:flex; align-items:center; gap:4px; margin-bottom:10px;">
        <span>â€¹</span> Firmalara DÃ¶n
      </div>
      <div id="d-header"></div>
      <div id="h-list"></div>
    </div>

    <div class="page" id="pg-satis">
      <h3>Yeni SatÄ±ÅŸ</h3>
      <div class="h-item" style="display:flex; flex-direction:column; gap:12px;">
        <select id="st-cari"></select>
        <input type="date" id="st-tarih">
        <input type="number" id="st-tutar" placeholder="Toplam Tutar â‚º" inputmode="decimal">
        <textarea id="st-aciklama" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        <button class="btn btn-accent" onclick="saveSatis()">Kaydet</button>
      </div>
    </div>

    <div class="page" id="pg-odemeler">
      <h3>Ã–deme Al</h3>
      <div class="h-item" style="display:flex; flex-direction:column; gap:12px;">
        <select id="od-cari"></select>
        <input type="date" id="od-tarih">
        <input type="number" id="od-tutar" placeholder="Ã–denen Tutar â‚º" inputmode="decimal">
        <button class="btn btn-accent" onclick="saveOdeme()" style="background:var(--green); color:#000;">Ã–demeyi Ä°ÅŸle</button>
      </div>
    </div>
  </div>

  <nav class="nav">
    <button class="nav-item active" onclick="navTo('cariler')"><span class="ni">ðŸ‘¥</span>Cariler</button>
    <button class="nav-item" onclick="navTo('satis')"><span class="ni">ðŸ›’</span>SatÄ±ÅŸ</button>
    <button class="nav-item" onclick="navTo('odemeler')"><span class="ni">ðŸ’°</span>Ã–deme</button>
    <button class="nav-item" onclick="alert('ÃœrÃ¼n YÃ¶netimi YakÄ±nda')"><span class="ni">ðŸ“¦</span>ÃœrÃ¼nler</button>
  </nav>
</div>

<script>
// â”€â”€ Core Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const today = () => new Date().toISOString().split('T')[0];
const fmt = n => new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(n);
const esc = s => { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; };

let S = { cariler: [], cari: null };

const api = {
  get: url => fetch(url).then(r => r.json()),
  post: (url, d) => fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}).then(r => r.json())
};

// â”€â”€ 1. CARÄ° DETAYDA HAREKET SÄ°LMEYÄ° KALDIR â”€â”€â”€â”€â”€â”€â”€
async function loadHareketler() {
  const rows = await api.get('/api/hareketler/' + S.cari.id);
  const el = $('h-list');
  
  if (!rows.length) {
    el.innerHTML = '<div style="text-align:center; padding:40px; color:var(--sub);">ðŸ“‹ HenÃ¼z hareket yok.</div>';
    return;
  }

  // Silme butonu (x) tamamen kaldÄ±rÄ±ldÄ±, dÃ¶kÃ¼m temizlendi
  el.innerHTML = [...rows].reverse().map(h => `
    <div class="h-item">
      <div class="h-row1">
        <div class="h-desc">${esc(h.aciklama || 'â€”')}</div>
        <div class="h-amount ${h.borc > 0 ? 'c-red' : 'c-green'}">
          ${h.borc > 0 ? '+' + fmt(h.borc) : '-' + fmt(h.alacak)}
        </div>
      </div>
      <div class="h-row2">
        <div class="h-row2-left">
          <span class="h-date">${h.tarih}</span>
          <span class="h-tag tag-${h.tur || 'manuel'}">${h.tur || 'manuel'}</span>
        </div>
        <span class="h-bkye">Bakiye: ${fmt(h.bakiye)}</span>
      </div>
    </div>`).join('');
}

// â”€â”€ 2. TEMA YÃ–NETÄ°MÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(mode){
  if(mode === 'light'){
    document.body.classList.add('light');
    $('theme-btn').textContent = 'â˜€ï¸';
    document.querySelector('meta[name=theme-color]').content = "#ffffff";
  } else {
    document.body.classList.remove('light');
    $('theme-btn').textContent = 'ðŸŒ™';
    document.querySelector('meta[name=theme-color]').content = "#0b0d14";
  }
  localStorage.setItem('theme', mode);
}

$('theme-btn').onclick = () => {
  const isLight = document.body.classList.contains('light');
  applyTheme(isLight ? 'dark' : 'light');
};

// â”€â”€ Navigasyon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navTo(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  $( 'pg-' + pageId ).classList.add('active');
  const navIdx = { cariler:0, satis:1, odemeler:2 }[pageId];
  if(navIdx !== undefined) document.querySelectorAll('.nav-item')[navIdx].classList.add('active');
  
  if(pageId === 'cariler') loadCariler();
  if(pageId !== 'detay') $('tb-crumb').textContent = '';
}

// â”€â”€ Cari Ä°ÅŸlemleri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCariler() {
  S.cariler = await api.get('/api/cariler');
  renderCariList(S.cariler);
  fillSelects();
}

function renderCariList(list) {
  $('cari-list').innerHTML = list.map(c => `
    <div class="h-item" onclick="showCariDetail(${c.id}, '${esc(c.firma_adi)}')">
      <div class="h-row1">
        <strong>${esc(c.firma_adi)}</strong>
        <span class="h-bkye">${fmt(c.bakiye || 0)} â‚º</span>
      </div>
      <div style="font-size:11px; color:var(--sub); margin-top:4px;">${esc(c.yetkili || 'Yetkili BelirtilmemiÅŸ')}</div>
    </div>`).join('');
}

function showCariDetail(id, name) {
  S.cari = { id, name };
  $('tb-crumb').textContent = name;
  navTo('detay');
  loadHareketler();
}

function filterCariler(q) {
  const filtered = S.cariler.filter(c => 
    c.firma_adi.toLowerCase().includes(q.toLowerCase()) || 
    (c.yetkili && c.yetkili.toLowerCase().includes(q.toLowerCase()))
  );
  renderCariList(filtered);
}

function fillSelects() {
  const opts = '<option value="">Cari SeÃ§in...</option>' + 
    S.cariler.map(c => `<option value="${c.id}">${esc(c.firma_adi)}</option>`).join('');
  $('st-cari').innerHTML = opts;
  $('od-cari').innerHTML = opts;
}

// â”€â”€ KayÄ±t Ä°ÅŸlemleri â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveSatis() {
  const d = {
    cari_id: $('st-cari').value,
    tarih: $('st-tarih').value,
    tutar: $('st-tutar').value,
    aciklama: $('st-aciklama').value
  };
  if(!d.cari_id || !d.tutar) return alert("Eksik alan!");
  await api.post('/api/satislar', d);
  alert("SatÄ±ÅŸ kaydedildi.");
  navTo('cariler');
}

async function saveOdeme() {
  const d = {
    cari_id: $('od-cari').value,
    tarih: $('od-tarih').value,
    tutar: $('od-tutar').value
  };
  if(!d.cari_id || !d.tutar) return alert("Eksik alan!");
  await api.post('/api/odemeler', d);
  alert("Ã–deme kaydedildi.");
  navTo('cariler');
}

// â”€â”€ 3. INIT & TARÄ°H OTOMASYONU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  // TemayÄ± yÃ¼kle
  applyTheme(localStorage.getItem('theme') || 'dark');

  // Tarihleri bugÃ¼ne ayarla
  if($('st-tarih')) $('st-tarih').value = today();
  if($('od-tarih')) $('od-tarih').value = today();

  loadCariler();
});

// Network Durumu
function updateNet() {
  const dot = $('net-dot');
  dot.classList.toggle('offline', !navigator.onLine);
}
window.addEventListener('online', updateNet);
window.addEventListener('offline', updateNet);
updateNet();

// Service Worker (PWA)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
</script>
</body>
</html>
